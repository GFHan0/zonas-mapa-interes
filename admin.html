<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - ValidaciÃ³n de Puntos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #2d2d2d; padding: 20px; border-radius: 12px; border-top: 5px solid #27ae60; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border-bottom: 1px solid #444; text-align: left; }
        th { background: #27ae60; }
        .btn { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin-right: 5px; }
        .btn-aprobar { background: #27ae60; }
        .btn-rechazar { background: #e67e22; }
        .btn-eliminar { background: #c0392b; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; text-transform: uppercase; }
        .pendiente { background: #f1c40f; color: black; }
        .aprobado { background: #27ae60; }
        .rechazado { background: #e67e22; }
        img { border-radius: 4px; transition: 0.3s; cursor: zoom-in; }
        img:hover { transform: scale(4); position: relative; z-index: 10; border: 2px solid white; }
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div id="login" class="login-overlay">
    <div style="text-align: center;">
        <h2>Acceso Restringido</h2>
        <input type="password" id="pass" placeholder="ContraseÃ±a de Admin" style="padding: 10px; border-radius: 5px; border: none;">
        <button class="btn btn-aprobar" onclick="verificar()">Entrar</button>
    </div>
</div>

<div class="container">
    <h1>ValidaciÃ³n de Patrocinios</h1>
    <p>Pasa el ratÃ³n sobre la foto para ampliarla.</p>
    <table>
        <thead>
            <tr>
                <th>Foto</th>
                <th>Patrocinador</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-puntos"></tbody>
    </table>
</div>

<script>
    const SUPABASE_URL = 'https://jwtruolnvepievxheuyh.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_8QmGDNmTJSCnnQT22-SSBA_9UFzR0YN';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function verificar() {
        const p = document.getElementById('pass').value;
        if (p === "ADMIN2026") { 
            document.getElementById('login').style.display = 'none';
            cargarReporte();
        } else {
            alert("Clave incorrecta");
        }
    }

    async function cargarReporte() {
        const { data, error } = await _supabase
            .from('puntos')
            .select('*')
            .order('id', { ascending: false });

        if (error) {
            console.error("Error:", error.message);
            return;
        }

        const tbody = document.getElementById('tabla-puntos');
        tbody.innerHTML = "";

        if (data) {
            data.forEach(p => {
                const foto = p.foto_url ? `<img src="${p.foto_url}" width="60" title="Ampliar">` : '<i>Sin foto</i>';
                // Usando el nombre correcto de tu columna: mensaje_admin
                const motivo = p.mensaje_admin ? `<br><small style="color:#aaa;">Motivo: ${p.mensaje_admin}</small>` : '';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${foto}</td>
                        <td><b>${p.nombre_patrocinador}</b>${motivo}</td>
                        <td><span class="badge ${p.estado}">${p.estado}</span></td>
                        <td>
                            ${p.estado === 'pendiente' ? `<button class="btn btn-aprobar" onclick="actualizar(${p.id}, 'aprobado')">Aprobar âœ…</button>` : ''}
                            <button class="btn btn-rechazar" onclick="rechazar(${p.id})">Rechazar âœ–</button>
                            <button class="btn btn-eliminar" onclick="eliminar(${p.id})">Eliminar ðŸ—‘</button>
                        </td>
                    </tr>
                `;
            });
        }
    }

    async function actualizar(id, nuevoEstado) {
        const { error } = await _supabase.from('puntos').update({ estado: nuevoEstado }).eq('id', id);
        if (error) alert(error.message);
        cargarReporte();
    }

    async function rechazar(id) {
        const motivo = prompt("Â¿Por quÃ© rechazas este punto?");
        if (!motivo) return;
        
        // Actualizamos usando mensaje_admin
        const { error } = await _supabase
            .from('puntos')
            .update({ estado: 'rechazado', mensaje_admin: motivo }) 
            .eq('id', id);
            
        if (error) alert(error.message);
        cargarReporte();
    }

    async function eliminar(id) {
        if (confirm("Â¿Seguro que quieres borrar este registro?")) {
            const { error } = await _supabase.from('puntos').delete().eq('id', id);
            if (error) alert(error.message);
            cargarReporte();
        }
    }
</script>
</body>
</html>

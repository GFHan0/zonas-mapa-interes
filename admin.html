<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin - ValidaciÃ³n de Puntos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #2d2d2d; padding: 20px; border-radius: 12px; border-top: 5px solid #27ae60; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border-bottom: 1px solid #444; text-align: left; }
        th { background: #27ae60; }
        .btn { border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin-right: 5px; }
        .btn-aprobar { background: #27ae60; }
        .btn-rechazar { background: #e67e22; }
        .btn-eliminar { background: #c0392b; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8em; }
        .pendiente { background: #f1c40f; color: black; }
        .aprobado { background: #27ae60; }
        .rechazado { background: #e67e22; }
        img { border-radius: 4px; transition: 0.3s; }
        img:hover { transform: scale(3); position: relative; z-index: 10; }
    </style>
</head>
<body>

<div class="container">
    <h1>ValidaciÃ³n de Patrocinios</h1>
    <table>
        <thead>
            <tr>
                <th>Foto</th>
                <th>Patrocinador</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tabla-puntos"></tbody>
    </table>
</div>

<script>
    const SUPABASE_URL = 'https://jwtruolnvepievxheuyh.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_8QmGDNmTJSCnnQT22-SSBA_9UFzR0YN';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function cargarReporte() {
        const { data } = await _supabase.from('puntos').select('*').order('creado_en', { ascending: false });
        const tbody = document.getElementById('tabla-puntos');
        tbody.innerHTML = "";

        if (data) {
            data.forEach(p => {
                const foto = p.foto_url ? `<img src="${p.foto_url}" width="60" title="Pasa el mouse para ampliar">` : 'Sin foto';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${foto}</td>
                        <td><b>${p.nombre_patrocinador}</b></td>
                        <td><span class="badge ${p.estado}">${p.estado}</span></td>
                        <td>
                            ${p.estado === 'pendiente' ? `<button class="btn btn-aprobar" onclick="actualizar(${p.id}, 'aprobado')">Aprobar âœ…</button>` : ''}
                            <button class="btn btn-rechazar" onclick="rechazar(${p.id})">Rechazar âœ–</button>
                            <button class="btn btn-eliminar" onclick="eliminar(${p.id})">Eliminar ðŸ—‘</button>
                        </td>
                    </tr>
                `;
            });
        }
    }

    async function actualizar(id, nuevoEstado) {
        await _supabase.from('puntos').update({ estado: nuevoEstado }).eq('id', id);
        cargarReporte();
    }

    async function rechazar(id) {
        const motivo = prompt("Â¿Por quÃ© rechazas este punto? (Se guardarÃ¡ en mensaje_admin)");
        if (!motivo) return;
        // Guardar motivo en la columna mensaje_admin
        await _supabase.from('puntos').update({ estado: 'rechazado', mensaje_admin: motivo }).eq('id', id);
        cargarReporte();
    }

    async function eliminar(id) {
        if (confirm("Â¿Seguro que quieres borrar este registro de la base de datos?")) {
            await _supabase.from('puntos').delete().eq('id', id);
            cargarReporte();
        }
    }

    cargarReporte();
</script>
</body>
</html>